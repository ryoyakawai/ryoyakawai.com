!function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);const i=!0;class n{static def_val(e,t){return void 0===e?t:e}static dec2hexString(e){return("00"+(e+0).toString(16).substr(-4).toUpperCase()).substr(-2)}static format_cmd(e=[]){if(0==e.length)return console.error("!!!! Parameter is not set !!!!"),"<<< ERROR >>>";let t=[];return e.forEach(e=>{t.push(n.dec2hexString(e)),t.push(n.dec2hexString(e))}),t.join(" ")}static bytes2hexs(e,t){let r;return t=this.def_val(t," "),e.map((function(e){return r=e.toString(16),e<16?"0"+r:r})).join(t).toUpperCase()}static array_tohexs(e,t,r){let i;return t=this.def_val(t,0),r=this.def_val(r,e.length-t),i=this.array_slice(e,t,r),this.bytes2hexs(i,"")}static __array_copy(e,t,r,i,n){let a,s=e.slice();for(i=this.def_val(i,0),n=this.def_val(n,r.length),a=0;a<n;a++)s[t+a]=r[i+a];return s}static array_copy(e,t,r,i,n){let a;for(i=this.def_val(i,0),n=this.def_val(n,r.length),a=0;a<n;a++)e[t+a]=r[i+a];return e}static array_slice(e,t,r){r=this.def_val(r,e.length-t);let i=[];return this.array_copy(i,0,e,t,r),i}static array_compare(e,t,r,i,n){let a;for(a=0;a<n;a++){if(void 0===e[t+a])return-1;if(void 0===r[i+a])return-1;if(e[t+a]!=r[i+a])return-1}return 0}static dataview_to_array(e){let t,r;for(t=new Array(e.byteLength),r=0;r<e.byteLength;r++)t[r]=e.getUint8(r);return t}static array_append(e,t,r,i){let n;for(r=this.def_val(r,0),i=this.def_val(i,t.length-r),n=0;n<i;n++)e.push(t[r+n]);return e}static array_set_uint16l(e,t,r){e[t]=255&r,e[t+1]=r>>8&255}static array_get_uint16l(e,t){return e[t+1]<<8|e[t]}static array_get_uint32l(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}static enableDebugLog(e=!1){let t=()=>{};return 1==e&&(console.log("[Set to show debug log]"),t=e=>{console.log("[DEBUG] ",e)}),t}static wait_async(e){return new Promise((t,r)=>{setTimeout(t,e)})}}function a(e,t){let r;return r=void 0===e?t:e,r}function s(e,t,r){let i;return i=c(e,t=a(t,0),r=a(r,e.length-t)),function(e,t){return t=a(t," "),e.map((function(e){let t=e.toString(16);return e<16&&(t="0"+t),t})).join(t).toUpperCase()}(i,"")}function _(e,t,r,i,n){let s;for(i=a(i,0),n=a(n,r.length),s=0;s<n;s++)e[t+s]=r[i+s];return e}function c(e,t,r){let i;return i=[],_(i,0,e,t,r=a(r,e.length-t)),i}function o(e,t,r,i,n){let a;for(a=0;a<n;a++){if(void 0===e[t+a])return-1;if(void 0===r[i+a])return-1;if(e[t+a]!=r[i+a])return-1}return 0}function l(e,t,r,i){let n;for(r=a(r,0),i=a(i,t.length-r),n=0;n<i;n++)e.push(t[r+n]);return e}function u(e,t,r){e[t]=255&r,e[t+1]=r>>8&255}function T(e,t){return e[t+1]<<8|e[t]}function I(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}var E=E||(()=>{});function R(e){return new Promise((t,r)=>{setTimeout(t,e)})}class h extends Error{static get INTERNAL_ERROR(){return-2}static get UNKNOWN_ERROR(){return-1}static get INVALID_PARAMETER(){return 1002}static get CANTCALLOUT_LIBRARY_STATUS(){return 1004}static get API_CALL_IN_PROGRESS(){return 1008}static get DEVICE_NOT_FOUND(){return 2018}static get DEVICE_OPEN_ERROR(){return 2019}static get DEVICE_FATAL_ERROR(){return 2020}static get TRANSFER_ERROR(){return 3001}static get INVALID_RESPONSE(){return 3003}static get INVALID_STATUS(){return 3004}static get ACK_TIMEOUT(){return 3005}static get DATA_RECEIVE_TIMEOUT(){return 3006}static get CARD_NOT_DETECTED(){return 4e3}static get AUTHENTICATION_ERROR(){return 4001}static get THRU_RESPONSE_PACKET_NOT_RECEIVED(){return 4002}constructor(e,t,r,i){super(t),this.errorType=e,this.fileName=r,this.lineNumber=i,this.communicationStatus=0}}class N extends class{async open(){}async transmit(e){return 0}async receive(e,t){return null}async clear(){}async close(){}}{constructor(){super(),this._fileName="GenericUSB.js",this.device=null,this.recv_buffer=[],this.receiver=null}async open(e,t,r,i,n){if(E("open begin"),null==this.device){try{this.device=await window.navigator.usb.requestDevice({filters:[{vendorId:e}]})}catch(e){return E(e.message),Promise.reject(new h(h.DEVICE_NOT_FOUND,e.message,this._fileName,34))}E(this.device.productName),E(this.device.manufacturerName),this.device.opend?E("device opened"):E("device not open");try{await this.device.open(),await this.device.selectConfiguration(t),await this.device.claimInterface(r)}catch(e){return this.device=null,E(e.message),Promise.reject(new h(h.DEVICE_OPEN_ERROR,e.message,this._fileName,52))}this.endno_out=i,this.endno_in=n,E("open end")}else E("open end (Already opened)")}async auto_open(e,t,r,i,n){let a;if(E("auto_open begin"),null==this.device){try{a=await navigator.usb.getDevices()}catch(e){return E(e.message),Promise.reject(new h(h.DEVICE_NOT_FOUND,e.message,this._fileName,78))}if(null==a||0==a.length)return await this.open(e,t,r,i,n);if(a.forEach(t=>{E(t.productName),E(t.manufacturerName),t.opend?E("device opened"):E("device not open"),t.vendorId!=e||(this.device=t)}),null==this.device)return await this.open(e,t,r,i,n);E(this.device.productName),E(this.device.manufacturerName);try{await this.device.open(),await this.device.selectConfiguration(t),await this.device.claimInterface(r)}catch(e){return this.device=null,E(e.message),Promise.reject(new h(h.DEVICE_OPEN_ERROR,e.message,this._fileName,118))}this.endno_out=i,this.endno_in=n,E("auto_open end")}else E("auto_open end (Already opened)")}async transmit(e){let t,r;return E("transmit begin"),E("Send length : %d",e.length),E("Send : "+s(e)),t=await this.device.transferOut(this.endno_out,Uint8Array.from(e)).then(t=>"ok"!=t.status?(r="transferOut Error",E("transferOut Error"),Promise.reject(new h(h.TRANSFER_ERROR,"transferOut Error",this._fileName,142))):e.length,e=>(E(e.message),Promise.reject(new h(h.TRANSFER_ERROR,e.message,this._fileName,150)))),E("transmit end"),t}get_buffer(e){let t;return E("get_buffer begin"),this.recv_buffer.length>=e?(t=c(this.recv_buffer,0,e),this.recv_buffer=c(this.recv_buffer,e,this.recv_buffer.length-e)):t=[],E("get_buffer end"),t}async receive(e,t){let r,i,n,a,s,_,c,o,l;return E("receive begin (req_len="+e+", timeout="+t+")"),r=new Date,0!=e&&this.recv_buffer.length>=e?(i=this.get_buffer(e),E("receive end(1)"),Promise.resolve(i)):(n=!1,i=this.transferin().then(()=>n?(E("receive in canceled function"),[]):this.recv_buffer.length<e?(s=new Date,_=s.getTime()-r.getTime(),_>t?(a="receive data receive timeout",E(a),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,a,this._fileName,213))):this.receive(e,t-_)):this.get_buffer(e),e=>(E(e.message),Promise.reject(new h(h.TRANSFER_ERROR,e.message,this._fileName,224)))),c=new Promise(e=>{o=setTimeout(e,t)}).then(()=>(n=!0,a="receive data receive timeout",E(a),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,a,this._fileName,232)))),l=await Promise.race([i,c]),clearTimeout(o),E("receive end(2)"),l)}async transferin(){let e,t;if(E("transferin begin"),null==this.receiver){if(E("receiver == null"),!this.device.opened)return this.receiver=null,e="Device is closed.",E(e),Promise.reject(new h(h.TRANSFER_ERROR,e,this._fileName,276));this.receiver=this.device.transferIn(this.endno_in,255).then(r=>(E("transferIn status : "+r.status),E("           data.byteLength : "+r.data.byteLength),"ok"!=r.status||0==r.data.byteLength?(e="transferIn Error",E(e),Promise.reject(new h(h.TRANSFER_ERROR,e,this._fileName,257))):(t=function(e){let t,r;for(t=new Array(e.byteLength),r=0;r<e.byteLength;r++)t[r]=e.getUint8(r);return t}(r.data),E("transferIn data : "+s(t)),_(this.recv_buffer,this.recv_buffer.length,t,0,t.length),this.receiver=null,Promise.resolve())),e=>(E(e.message),Promise.reject(new h(h.TRANSFER_ERROR,e.message,this._fileName,270))))}else E("receiver != null");return E("transferin end"),this.receiver}async clear(){E("clear begin"),this.recv_buffer=[],E("clear end")}async close(){if(E("close begin"),null!=this.device){try{await this.device.close()}catch(e){E(e.message)}this.device=null}E("close end")}}class A{constructor(e,t,r,i,n,a){this.idm=e,this.pmm=t,this.uid=r,this.pupi=i,this.systemCode=n,this.baudRate=a}}class m{constructor(e,t,r,i){this.ackTimeout=e,this.receiveTimeout=t,this.autoBaudRate=r,this.autoDeviceSelect=i}}class d{constructor(e,t,r,i,n,a){this.systemCode=e,this.timeSlot=t,this.requestSystemCode=r,this.requestBaudRate=i,this.fsdi=n,this.cid=a}}function C(e,t,r){this.pupi=e,this.application_data=t,this.protocol_info=r}function S(e){return(e+13560-1)/13560}function O(e){return S(4096*(1<<e))}const g=S(1152)+S(84),f=S(16);class P extends class{constructor(){this._deviceName=null,this._targetCardBaudRate=null}get deviceName(){return this._deviceName}get targetCardBaudRate(){return this._targetCardBaudRate}async init(e){}async open(){}async detectCard(e,t){}async communicateThru(e,t,r){}async switchRF(e){}async close(){}}{static get VENDOR_ID(){return 1356}static get SELECT_CONFIG(){return 1}static get CLAIM_INTERFACE(){return 0}static get ENDPOINT_IN(){return 1}static get ENDPOINT_OUT(){return 2}static get COMMAND_TYPE_0(){return 0}static get COMMAND_TYPE_1(){return 1}static get NFC100_COMMAND_CODE(){return 214}static get NFC100_RESPONSE_CODE(){return 215}static get SCC_SET_COMMAND_TYPE(){return 42}static get SRC_SET_COMMAND_TYPE(){return 43}static get SCC_IN_SET_RF(){return 0}static get SRC_IN_SET_RF(){return 1}static get SCC_IN_SET_PROTOCOL(){return 2}static get SRC_IN_SET_PROTOCOL(){return 3}static get SCC_IN_COMM_RF(){return 4}static get SRC_IN_COMM_RF(){return 5}static get SCC_SWITCH_RF(){return 6}static get SRC_SWITCH_RF(){return 7}static get SCC_GET_PDDATA_VERSION(){return 34}static get SRC_GET_PDDATA_VERSION(){return 35}static get SCC_GET_PROPERTY(){return 36}static get SRC_GET_PROPERTY(){return 37}static get SCC_IN_SET_RCT(){return 48}static get SRC_IN_SET_RCT(){return 49}static get SCC_IN_GET_RCT(){return 50}static get SRC_IN_GET_RCT(){return 51}static get SCC_READ_REGISTER(){return 54}static get SRC_READ_REGISTER(){return 55}static get SCC_DIAGNOSE(){return 240}static get SRC_DIAGNOSE(){return 241}static get STATUS_SUCCESS(){return 0}static get STATUS_PARAMETER_ERROR(){return 1}static get STATUS_PB_ERROR(){return 2}static get STATUS_RFCA_ERROR(){return 3}static get STATUS_TEMPERATURE_ERROR(){return 4}static get STATUS_PWD_ERROR(){return 5}static get STATUS_RECEIVE_ERROR(){return 6}static get STATUS_COMMANDTYPE_ERROR(){return 7}static get STATUS_INTTEMPRFOFF_ERROR(){return 9}static get COM_STATUS_PROTOCOL_ERROR(){return 1}static get COM_STATUS_PARITY_ERROR(){return 2}static get COM_STATUS_CRC_ERROR(){return 4}static get COM_STATUS_COLLISION_ERROR(){return 8}static get COM_STATUS_OVERFLOW_ERROR(){return 16}static get COM_STATUS_TEMPERATURE_ERROR(){return 64}static get COM_STATUS_REC_TIMEOUT_ERROR(){return 128}static get COM_STATUS_CRYPTO1_ERROR(){return 256}static get COM_STATUS_RFCA_ERROR(){return 512}static get COM_STATUS_INTTEMPRFOFF_ERROR(){return 4096}static get SWITCH_RF_RFON(){return 1}static get SWITCH_RF_RFOFF(){return 0}static get REG_ADR_RF_STATE(){return 20}static get REG_ADR_RF_STATE_ON(){return 131}static get REG_ADR_RF_STATE_OFF(){return 128}static get NFC100_MAX_SWICH_RF_RETRY_COUNT(){return 3}static get NFC100_MAX_SWICH_RF_EXECUTION_COUNT(){return P.NFC100_MAX_SWICH_RF_RETRY_COUNT+1}static get DIAGNOSE_COMMUNICATION_LINE_TEST(){return 0}static get DIAGNOSE_ROM_TEST(){return 1}static get DIAGNOSE_RAM_TEST(){return 2}static get DIAGNOSE_POLLING_TEST(){return 3}static get DIAGNOSE_RF_REGULATION_TEST(){return 4}static get DIAGNOSE_GET_UPDATE_SUCCESS_COUNT(){return 5}static get DIAGNOSE_OUTPUT_TRIGGER_SIGNAL(){return 6}static get DIAGNOSE_TEMP_ABNORMAL_MEMORY_MANAGE(){return 7}static get DIAGNOSE_TEST_MIN(){return P.DIAGNOSE_COMMUNICATION_LINE_TEST}static get DIAGNOSE_TEST_MAX(){return P.DIAGNOSE_TEMP_ABNORMAL_MEMORY_MANAGE}static get DIAGNOSE_TIMEOUT_COMMUNICATION_LINE_TEST(){return 1e3}static get DIAGNOSE_TIMEOUT_ROM_TEST(){return 1e3}static get DIAGNOSE_TIMEOUT_RAM_TEST(){return 1e3}static get DIAGNOSE_TIMEOUT_POLLING_TEST(){return 1e3}static get DIAGNOSE_TIMEOUT_RF_REGULATION_TEST(){return 1e3}static get DIAGNOSE_TIMEOUT_GET_UPDATE_SUCCESS_COUNT(){return 1e3}static get DIAGNOSE_TIMEOUT_OUTPUT_TRIGGER_SIGNAL(){return 1e3}static get DIAGNOSE_TIMEOUT_TEMP_ABNORMAL_MEMORY_MANAGE(){return 1e3}static get NFC100_RBT_INITIATOR_ISO18092_212K(){return 1}static get NFC100_RBT_INITIATOR_ISO18092_424K(){return 1}static get NFC100_RBT_INITIATOR_ISO14443A_106K(){return 2}static get NFC100_RBT_INITIATOR_ISO14443B_106K(){return 3}static get NFC100_RBT_INITIATOR_ISO14443B_212K(){return 3}static get NFC100_RBT_INITIATOR_ISO14443B_424K(){return 3}static get NFC100_RBT_INITIATOR_ISO14443B_848K(){return 3}static get NFC100_RBT_INITIATOR_ISO14443A_212K(){return 4}static get NFC100_RBT_INITIATOR_ISO14443A_424K(){return 5}static get NFC100_RBT_INITIATOR_ISO14443A_848K(){return 6}static get NFC100_RF_INITIATOR_ISO18092_212K(){return 1}static get NFC100_RF_INITIATOR_ISO18092_424K(){return 2}static get NFC100_RF_INITIATOR_ISO18092_106K(){return 3}static get NFC100_RF_INITIATOR_ISO14443A_106K(){return 3}static get NFC100_RF_INITIATOR_ISO14443A_212K(){return 4}static get NFC100_RF_INITIATOR_ISO14443A_424K(){return 5}static get NFC100_RF_INITIATOR_ISO14443A_848K(){return 6}static get NFC100_RF_INITIATOR_ISO14443B_106K(){return 7}static get NFC100_RF_INITIATOR_ISO14443B_212K(){return 8}static get NFC100_RF_INITIATOR_ISO14443B_424K(){return 9}static get NFC100_RF_INITIATOR_ISO14443B_848K(){return 10}static get NFC100_IN_SET_RCT_SETTING_NUM_MAX(){return 16}static get RF_NOISE_RESISTANT_IMPROVEMENT(){return[26,192,64]}static get ACK_CMD(){return[0,0,255,0,255,0]}static get WAIT_AFTER_SEND_ACK(){return 5}static get BUFFER_CLEAR_TIMEOUT(){return 500}static get FELICA_CMD_POLLING(){return 0}static get FELICA_RES_POLLING(){return 1}static get FELICA_POLLING_TIMESLOT1(){return 0}static get FELICA_POLLING_TIMESLOT2(){return 1}static get FELICA_POLLING_TIMESLOT4(){return 3}static get FELICA_POLLING_TIMESLOT8(){return 7}static get FELICA_POLLING_TIMESLOT16(){return 15}static get FELICA_POLLING_OPTION_NONE(){return 0}static get FELICA_POLLING_OPTION_REQ_SYSCODE(){return 1}static get FELICA_POLLING_OPTION_REQ_BAUDRATE(){return 2}static get FELICA_POLLING_BAUDRATE_212K(){return 1}static get FELICA_POLLING_BAUDRATE_424K(){return 2}static get FELICA_POLLING_BAUDRATE_AUTO_DETECT(){return 128}static get felica_default_protocol(){return[0,21,1,1,2,1,3,0,4,0,5,0,6,0,7,8,8,0,9,0,10,0,11,0,12,0,14,0,15,5,16,255,17,0,18,0,19,6]}static get NFC100_TYPEA_CMD_REQA(){return 38}static get NFC100_TYPEA_CMD_WUPA(){return 82}static get NFC100_TYPEA_CMD_HLTA(){return 80}static get NFC100_TYPEA_CMD_SEL_CL_1(){return 147}static get NFC100_TYPEA_CMD_SEL_CL_2(){return 149}static get NFC100_TYPEA_CMD_SEL_CL_3(){return 151}static get NFC100_TYPEA_CMD_PPS(){return 208}static get typea_default_protocol(){return[0,6,1,1,2,1,3,0,4,1,5,1,6,0,7,8,8,0,9,0,10,0,11,0,12,0,14,4,15,0,16,0,17,0,18,0,19,6]}static get NFC100_TYPEB_CMD_REQB(){return 5}static get NFC100_TYPEB_CMD_HLTB(){return 80}static get NFC100_TYPEB_CMD_ATTRIB(){return 29}static get TYPEB_CARD_MAX_ATTRIB_LEN(){return 256}static get typeb_default_protocol(){return[0,20,1,1,2,1,3,0,4,0,5,0,6,0,7,8,8,0,9,1,10,1,11,1,12,1,14,4,15,0,16,0,17,0,18,0,19,6]}static get ISO14443_4_CC_DEFAULT_SFGI(){return 14}static get LT_INFO_TABLE(){return[[0,0,1,1,139,91,9,236,122,221,197,129,0,151,75,95,164,118,161,213],[0,1,1,0,213,159,243,133,168,199,47,105,44,65,173,1,230,180,145,103],[0,6,1,0,106,206,150,130,181,221,246,214,152,205,55,232,219,31,152,186],[0,8,1,0,71,212,66,85,79,225,65,241,115,21,127,202,181,114,86,210]]}static get NFC100_RR_INFO(){return[15,30,45,60,75,90,105,123,135,150,165,180,195,210,225,240]}static get PROTOCOL_ISO18092(){return"iso18092"}static get PROTOCOL_FELICA(){return"FeliCa"}static get PROTOCOL_ISO14443_3A(){return"iso14443-3A"}static get PROTOCOL_ISO14443_4A(){return"iso14443-4A"}static get PROTOCOL_ISO14443_4B(){return"iso14443-4B"}static get NFC100_FELICA_DETECT_TIMEOUT(){return 100}static get NFC100_DEFAULT_ACK_TIMEOUT(){return 1e3}static get NFC100_DEFAULT_RECEIVE_TIMEOUT(){return 1e3}static get COMMUNICATE_THRU_MIN_TIMEOUT(){return 400}static get COMMUNICATE_THRU_DEFAULT_TIMEOUT(){return 400}static get NFC100_TYPEA_DEFAULT_FSDI(){return 8}static get NFC100_TYPEA_DEFAULT_CID(){return 2}static get NFC100_TYPEB_DEFAULT_FSDI(){return 8}static get NFC100_TYPEB_DEFAULT_CID(){return 2}static get BAUDRATE_106K(){return 106}static get BAUDRATE_212K(){return 212}static get BAUDRATE_424K(){return 424}static get BAUDRATE_848K(){return 848}constructor(){super(),super._deviceName="NFCPort100",this._fileName="NFCPort100.js",this.communicator=new N,this.config=null,this.protocol="",this.bAbnormalState=!1}async init(e){let t;if(E("init begin"),null==e)return t="Parameter config is not specified",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,323));this.config=e,this.protocol="",this.bAbnormalState=!1,E("init end")}async open(){let e;if(E("open begin"),null==this.config)return e="not initialized",E(e),Promise.reject(new h(h.INTERNAL_ERROR,e,this._fileName,344));if(this.bAbnormalState)return e="Status is abnormaled",E(e),Promise.reject(new h(h.INTERNAL_ERROR,e,this._fileName,352));this.protocol="",this.bAbnormalState=!1,this.config.autoDeviceSelect?await this.communicator.auto_open(P.VENDOR_ID,P.SELECT_CONFIG,P.CLAIM_INTERFACE,P.ENDPOINT_OUT,P.ENDPOINT_IN):await this.communicator.open(P.VENDOR_ID,P.SELECT_CONFIG,P.CLAIM_INTERFACE,P.ENDPOINT_OUT,P.ENDPOINT_IN),await this.send_ack();try{await this.SetCommandType(P.COMMAND_TYPE_1)}catch(e){if(e.errorType!=h.INVALID_STATUS)return Promise.reject(e);await this.SetCommandType(P.COMMAND_TYPE_0)}await this.set_felica_rf_speed_and_protocol(P.BAUDRATE_212K),this.protocol=P.PROTOCOL_FELICA,await this.rf_on(),E("open end")}async detectCard(e,t){let r,i;if(E("detectCard begin"),this.bAbnormalState)return i="Status is abnormaled",E(i),Promise.reject(new h(h.INTERNAL_ERROR,i,this._fileName,394));if(e==P.PROTOCOL_ISO18092||e==P.PROTOCOL_FELICA)this.protocol=P.PROTOCOL_ISO18092,r=await this.detectCard_FeliCa(t);else if(e==P.PROTOCOL_ISO14443_3A)this.protocol=P.PROTOCOL_ISO14443_3A,r=await this.detectCard_TypeA(t);else if(e==P.PROTOCOL_ISO14443_4A)this.protocol=P.PROTOCOL_ISO14443_4A,r=await this.detectCard_TypeA(t);else{if(e!=P.PROTOCOL_ISO14443_4B)return i="Invalid parameter (protocol)",E(i),Promise.reject(new h(h.INVALID_PARAMETER,i,this._fileName,412));this.protocol=P.PROTOCOL_ISO14443_4B,r=await this.detectCard_TypeB(t)}return E("detectCard end"),r}async communicateThru(e,t,r){let i,n;return E("communicateThru begin"),this.bAbnormalState?(i="Status is abnormaled",E(i),Promise.reject(new h(h.INTERNAL_ERROR,i,this._fileName,428))):this.protocol==P.PROTOCOL_ISO14443_3A&&null!=r&&r.mifareAuthentication||!(null==e||e.length<=0)?(this.protocol==P.PROTOCOL_ISO14443_3A&&null!=r&&r.mifareAuthentication&&await this.typea_mifareAuth(r),null!=e?(t<P.COMMUNICATE_THRU_MIN_TIMEOUT&&(t=P.COMMUNICATE_THRU_MIN_TIMEOUT),n=await this.InCommRF(e,t)):n=null,E("communicateThru end"),n):(i="Invalid parameter (command)",E(i),Promise.reject(new h(h.INVALID_PARAMETER,i,this._fileName,435)))}async switchRF(e){let t;return E("switchRF begin"),this.bAbnormalState?(t="Status is abnormaled",E(t),Promise.reject(new h(h.INTERNAL_ERROR,t,this._fileName,473))):null==e?(t="Invalid parameter (on)",E(t),Promise.reject(new h(h.INTERNAL_ERROR,t,this._fileName,479))):(e?await this.rf_on():await this.rf_off(),void E("switchRF end"))}async close(){if(E("close begin"),!this.bAbnormalState)try{await this.rf_off()}catch(e){}try{await this.communicator.close()}catch(e){}this.protocol="",this.bAbnormalState=!1,E("close end")}async detectCard_FeliCa(e){let t,r,i,n,a,_,o,l,u;if(E("detectCard_FeliCa begin"),null==e||null==e.systemCode||2!=e.systemCode.length||null==e.timeSlot||e.timeSlot!=P.FELICA_POLLING_TIMESLOT1&&e.timeSlot!=P.FELICA_POLLING_TIMESLOT2&&e.timeSlot!=P.FELICA_POLLING_TIMESLOT4&&e.timeSlot!=P.FELICA_POLLING_TIMESLOT8&&e.timeSlot!=P.FELICA_POLLING_TIMESLOT16||null==e.requestSystemCode||null==e.requestBaudRate||e.requestSystemCode&&e.requestBaudRate)return t="Invalid parameter (option)",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,546));await this.set_felica_rf_speed_and_protocol(P.BAUDRATE_212K),await this.rf_on(),r=[6,P.FELICA_CMD_POLLING,e.systemCode[0],e.systemCode[1],0,0],e.requestSystemCode?r[4]=P.FELICA_POLLING_OPTION_REQ_SYSCODE:e.requestBaudRate||this.config.autoBaudRate?r[4]=P.FELICA_POLLING_OPTION_REQ_BAUDRATE:r[4]=P.FELICA_POLLING_OPTION_NONE,null!=e&&null!=e.timeSlot&&(r[5]=e.timeSlot);try{i=await this.InCommRF(r,P.NFC100_FELICA_DETECT_TIMEOUT)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}if(i.length<18)return t="Illegal polling response length",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,580));if(n=i.length>=20?c(i,18,2):[],r[4]==P.FELICA_POLLING_OPTION_REQ_SYSCODE?(a=n,_=null):r[4]==P.FELICA_POLLING_OPTION_REQ_BAUDRATE?(a=null,_=n):(a=null,_=null),o=e.requestSystemCode?new Uint8Array(a):null,l=e.requestBaudRate?new Uint8Array(_):null,u=new A(new Uint8Array(c(i,2,8)),new Uint8Array(c(i,10,8)),null,null,o,l,null,null),E("IDm :"+s(u.idm)),E("PMm :"+s(u.pmm)),null!=u.systemCode&&E("SystemCode :"+s(u.systemCode)),this.config.autoBaudRate){if(r[4]!=P.FELICA_POLLING_OPTION_REQ_BAUDRATE){r[4]=P.FELICA_POLLING_OPTION_REQ_BAUDRATE;try{i=await this.InCommRF(r,P.NFC100_FELICA_DETECT_TIMEOUT)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}i.length>=20&&(_=c(i,18,2))}null!=_&&2==_.length&&0!=(_[1]&P.FELICA_POLLING_BAUDRATE_AUTO_DETECT)&&0!=(_[1]&P.FELICA_POLLING_BAUDRATE_424K)&&await this.set_felica_rf_speed_and_protocol(P.BAUDRATE_424K)}return E("detectCard_FeliCa end"),u}async detectCard_TypeA(e){let t,r,i,n,a,s,_,c,o;return E("detectCard_TypeA begin"),t=P.NFC100_RBT_INITIATOR_ISO14443A_106K,r=P.NFC100_RF_INITIATOR_ISO14443A_106K,i=P.NFC100_RBT_INITIATOR_ISO14443A_106K,n=P.NFC100_RF_INITIATOR_ISO14443A_106K,await this.InSetRF(t,r,i,n),await this.InSetProtocol(P.typea_default_protocol),super._targetCardBaudRate=P.BAUDRATE_106K,await this.rf_on(),a=await this.typea_reqa_wupa(),s=await this.typea_anticollision(),null!=s&&(s=new Uint8Array(s)),this.protocol==P.PROTOCOL_ISO14443_4A&&(_=null!=e.fsdi?e.fsdi:P.NFC100_TYPEA_DEFAULT_FSDI,c=null!=e.cid?e.cid:P.NFC100_TYPEA_DEFAULT_CID,await this.typea_iso14443_4_activate(_,c,this.config.autoBaudRate)),await this.InSetProtocol(P.typea_default_protocol),o=new A(null,null,s,null,null,null),E("detectCard_TypeA end"),o}async detectCard_TypeB(e){let t,r,i,n,a,s,_,c,o,l,u,T,I,R;return E("detectCard_TypeB begin"),t=P.NFC100_RBT_INITIATOR_ISO14443B_106K,r=P.NFC100_RF_INITIATOR_ISO14443B_106K,i=P.NFC100_RBT_INITIATOR_ISO14443B_106K,n=P.NFC100_RF_INITIATOR_ISO14443B_106K,await this.InSetRF(t,r,i,n),await this.InSetProtocol(P.typeb_default_protocol),super._targetCardBaudRate=106,await this.rf_on(),a=0,s=!0,_=!1,c=!1,o=await this.typeb_reqb_wupb(0,!0,!1,!1),0!=(1&o.protocol_info[1])&&(l=null!=e.fsdi?e.fsdi:P.NFC100_TYPEB_DEFAULT_FSDI,u=null!=e.cid?e.cid:P.NFC100_TYPEB_DEFAULT_CID,T=null,await this.typeb_iso14443_4_activate(o.pupi,l,o.protocol_info,u,null,this.config.autoBaudRate)),await this.InSetProtocol(P.typeb_default_protocol),I=null!=o.pupi?new Uint8Array(o.pupi):null,R=new A(null,null,null,I,null,null),E("detectCard_TypeB end"),R}async rf_on(){let e,t;for(E("rf_on begin"),e=0;e<P.NFC100_MAX_SWICH_RF_EXECUTION_COUNT;e++){await this.SwitchRF(P.SWITCH_RF_RFON);try{if(t=await this.ReadRegister(P.NFC100_RR_INFO,P.REG_ADR_RF_STATE),t==P.REG_ADR_RF_STATE_ON)break}catch(e){}}e>=P.NFC100_MAX_SWICH_RF_EXECUTION_COUNT?E("rf_on Failed"):E("rf_on end")}async rf_off(){let e,t;for(E("rf_off begin"),e=0;e<P.NFC100_MAX_SWICH_RF_EXECUTION_COUNT;e++){await this.SwitchRF(P.SWITCH_RF_RFOFF);try{if(t=await this.ReadRegister(P.NFC100_RR_INFO,P.REG_ADR_RF_STATE),t==P.REG_ADR_RF_STATE_OFF)break}catch(e){}e<P.NFC100_MAX_SWICH_RF_EXECUTION_COUNT-1&&await this.SwitchRF(P.SWITCH_RF_RFON)}e>=P.NFC100_MAX_SWICH_RF_EXECUTION_COUNT?E("rf_off Failed"):E("rf_off end")}async send_ack(){E("send_ack begin"),await this.communicator.clear(),await this.communicator.transmit(P.ACK_CMD),await R(P.WAIT_AFTER_SEND_ACK),E("send_ack end")}async set_felica_rf_speed_and_protocol(e){let t,r,i,n,a,s,_;E("set_felica_rf_speed begin"),null!=e&&e==P.BAUDRATE_424K?(t=P.NFC100_RBT_INITIATOR_ISO18092_424K,r=P.NFC100_RF_INITIATOR_ISO18092_424K,i=P.NFC100_RBT_INITIATOR_ISO18092_424K,n=P.NFC100_RF_INITIATOR_ISO18092_424K):(e=P.BAUDRATE_212K,t=P.NFC100_RBT_INITIATOR_ISO18092_212K,r=P.NFC100_RF_INITIATOR_ISO18092_212K,i=P.NFC100_RBT_INITIATOR_ISO18092_212K,n=P.NFC100_RF_INITIATOR_ISO18092_212K),await this.InSetRF(t,r,i,n);try{a=await this.get_lt_info(),null!=a&&(s=await this.InGetRCT(a),null!=s&&(_=await this.update_rct_setting(s.in_receive_setting,P.RF_NOISE_RESISTANT_IMPROVEMENT),null!=_&&await this.InSetRCT(a,s.in_send_setting,s.in_receive_setting)))}catch(e){}await this.InSetProtocol(P.felica_default_protocol),super._targetCardBaudRate=e,E("set_felica_rf_speed end")}async receive_ack(e){let t,r,i,n,a,_;for(E("receive_ack begin (timeout="+e+")"),t=new Date,r=[];;){if(n=new Date,a=n.getTime()-t.getTime(),a>e)return _="receive_ack receive Timeout",E(_),Promise.reject(new h(h.ACK_TIMEOUT,_,this._fileName,951));if(i=await this.communicator.receive(P.ACK_CMD.length-r.length,e-a),E("Receive : "+s(i)),l(r,i),r.length>=P.ACK_CMD.length){if(0==o(r,0,P.ACK_CMD,0,P.ACK_CMD.length))break;r=c(r,1)}}return E("receive_ack end"),r}async send_packet_ext(e){let t,r;return E("send_packet_ext begin"),await this.communicator.clear(),t=new Uint8Array(8+e.length+2),t[0]=0,t[1]=0,t[2]=255,t[3]=255,t[4]=255,u(t,5,e.length),t[7]=this.get_packet_length_checksum(e.length),_(t,8,e,0,e.length),t[8+e.length]=this.get_packet_data_checksum(e),t[8+e.length+1]=0,r=await this.communicator.transmit(t),E("send_packet_ext end"),r}get_packet_length_checksum(e){return 255&-((e>>8&255)+(255&e))}get_packet_data_checksum(e){let t,r=0;for(r=0,t=0;t<e.length;t++)r+=e[t];return 255&-r}async receive_packet(e,t){let r,i,n,a,_,c;return E("receive_packet begin (timeout="+t+")"),r=new Date,E("start time="+r.getTime()),i=0,n=await this.communicator.receive(5,t).then(e=>(E("Frame : "+s(e)),0==e[0]&&0==e[1]&&255==e[2]&&255==e[3]&&255==e[4]?(a=new Date,_=a.getTime()-r.getTime(),_>t?(c="receive_packet reslen checksum receive timeout",E(c),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,c,this._fileName,1041))):this.communicator.receive(3,t-_).then(e=>(i=T(e,0),this.get_packet_length_checksum(i)!=e[2]?(c="receive_packet response reslen checksum error",E(c),Promise.reject(new h(h.INVALID_RESPONSE,c,this._fileName,1052))):(a=new Date,_=a.getTime()-r.getTime(),_>t?(c="receive_packet response-data receive timeout",E(c),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,c,this._fileName,1062))):this.communicator.receive(i,t-_))))):(i=e[3],this.get_packet_length_checksum(i)!=e[4]?(c="receive_packet Error-response reslen checksum error",E(c),Promise.reject(new h(h.INVALID_RESPONSE,c,this._fileName,1072))):(a=new Date,_=a.getTime()-r.getTime(),_>t?(c="receive_packet response-data receive timeout",E(c),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,c,this._fileName,1080))):this.communicator.receive(i,t-_))))).then(t=>(E("Receive : "+s(t)),e!=t[0]?(c="receive_packet invalid res-code",E(c),Promise.reject(new h(h.INVALID_RESPONSE,c,this._fileName,1093))):t)).then(e=>(a=new Date,_=a.getTime()-r.getTime(),_>t?(c="receive_packet dcs receive timeout",E(c),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,c,this._fileName,1104))):this.communicator.receive(2,t-_).then(t=>this.get_packet_data_checksum(e)!=t[0]||0!=t[1]?(c="receive_packet dcs checksum error",E(c),Promise.reject(new h(h.INVALID_RESPONSE,c,this._fileName,1114))):e))),E("receive_packet end"),n}async receive_ack_and_response(e,t){let r,i,n,a,_,u,I,R,N;for(E("receive_ack_and_response begin"),null==t&&(t=null!=this.config&&null!=this.config.receiveTimeout?this.config.receiveTimeout:P.NFC100_DEFAULT_RECEIVE_TIMEOUT),r=new Date,i=[];;){for(E("search ACK");;){if(n=new Date,a=n.getTime()-r.getTime(),a>t)return _="transceive ACK receive Timeout",E(_),Promise.reject(new h(h.ACK_TIMEOUT,_,this._fileName,1158));if(i.length<P.ACK_CMD.length&&(u=await this.communicator.receive(P.ACK_CMD.length-i.length,t-a),E("Receive : "+s(u)),l(i,u)),i.length>=P.ACK_CMD.length){if(0==o(i,0,P.ACK_CMD,0,P.ACK_CMD.length)){i=c(i,P.ACK_CMD.length);break}i=c(i,1)}}if(i.length<5){if(n=new Date,a=n.getTime()-r.getTime(),a>t)return _="transceive Response receive Timeout",E(_),Promise.reject(new h(h.ACK_TIMEOUT,_,this._fileName,1190));I=0,u=await this.communicator.receive(5-i.length,t-a),l(i,u)}if(E("Preamble & SPC & Ext Frame Code : "+s(i,0,5)),0==i[0]&&0==i[1]&&255==i[2]&&255==i[3]&&255==i[4]){if(i=c(i,5),i.length<3){if(n=new Date,E("current time="+n.getTime()),a=n.getTime()-r.getTime(),E("elapsed = "+a),a>t)return _="receive_packet reslen checksum receive timeout",E(_),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,_,this._fileName,1214));u=await this.communicator.receive(3-i.length,t-a),l(i,u)}if(E("Length & LCS : "+s(i,0,3)),I=T(i,0),I>=2&&this.get_packet_length_checksum(I)==i[2]){if(R=c(i,3),R.length<2){if(n=new Date,a=n.getTime()-r.getTime(),a>t)return _="receive_packet response-data receive timeout",E(_),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,_,this._fileName,1236));u=await this.communicator.receive(2-R.length,t-a),l(i,u),l(R,u)}if(E("Res Comand + SubRes Command : "+s(R,0,2)),P.NFC100_RESPONSE_CODE==R[0]&&e==R[1]){if(i=R,i.length<I){if(n=new Date,a=n.getTime()-r.getTime(),a>t)return _="receive_packet response-data receive timeout",E(_),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,_,this._fileName,1256));u=await this.communicator.receive(I-i.length,t-a),l(i,u)}if(E("Res data(remain) : "+s(i,2,I-2)),N=c(i,0,I),i=c(i,I),i.length<2){if(n=new Date,a=n.getTime()-r.getTime(),a>t)return _="receive_packet dcs receive timeout",E(_),Promise.reject(new h(h.DATA_RECEIVE_TIMEOUT,_,this._fileName,1278));u=await this.communicator.receive(2-i.length,t-a),l(i,u)}if(E("DCS & Postamble : "+s(i)),this.get_packet_data_checksum(N)!=i[0]||0!=i[1])return _="receive_packet dcs checksum error",E(_),Promise.reject(new h(h.INVALID_RESPONSE,_,this._fileName,1293));break}}}}return E("receive_ack_and_response end"),R}async error_recovery(e){E("error_recovery begin");try{await this.send_ack(),e&&await this.communicator.receive(0,P.BUFFER_CLEAR_TIMEOUT)}catch(e){}E("error_recovery end")}async tranceive_ext(e){let t,r;E("tranceive_ext begin");try{await this.send_packet_ext(e)}catch(e){return E("tranceive_ext send error catch"),await this.error_recovery(!1),Promise.reject(e)}t=null!=this.config&&null!=this.config.ackTimeout?this.config.ackTimeout:P.NFC100_DEFAULT_ACK_TIMEOUT;try{r=await this.receive_ack(t).then(e=>(t=null!=this.config&&null!=this.config.receiveTimeout?this.config.receiveTimeout:P.NFC100_DEFAULT_RECEIVE_TIMEOUT,this.receive_packet(P.NFC100_RESPONSE_CODE,t)))}catch(e){return E("tranceive_ext receive error catch"),await this.error_recovery(!0),Promise.reject(e)}return E("tranceive_ext end"),r}async get_lt_info(){let e,t,r,i,n,a,s,_;for(E("get_lt_info begin"),e=await this.GetProperty(),t=[e[14],e[15]],r=!1,i=0;i<P.LT_INFO_TABLE.length;i++)if(n=P.LT_INFO_TABLE[i],n[0]==t[0]&&n[1]==t[1]){r=!0;break}if(!r)return a="LT-Info unsuported Reader/Writer.",E(a),null;for(s=await this.GetPDDataVersion(),_=null,i=0;i<P.LT_INFO_TABLE.length;i++)if(n=P.LT_INFO_TABLE[i],n[0]==t[0]&&n[1]==t[1]&&n[2]==s[0]&&n[3]==s[1]){_=c(n,4);break}return null==_?(a="LT-Info unsuported Reader/Writer.",E(a),null):(E("get_lt_info end"),_)}async update_rct_setting(e,t){let r,i,n,a;for(E("update_rct_setting begin"),r=e.length/3,i=0;i<r;i++)if(n=3*i,e[n]==t[0]&&e[n+1]==t[1])return e[n+2]==t[2]?null:(e[n+2]=t[2],e);return r>=P.NFC100_IN_SET_RCT_SETTING_NUM_MAX?null:(a=l(e,t),E("update_rct_setting end"),a)}async SetCommandType(e){let t,r,i;if(E("SetCommandType begin"),null==e)return t="Invalid parameter (type)",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,1467));r=new Uint8Array(3),r[0]=P.NFC100_COMMAND_CODE,r[1]=P.SCC_SET_COMMAND_TYPE,r[2]=e,i=await this.tranceive_ext(r).then(e=>3!=e.length?(t="Illegal response length",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1482))):e[0]!=P.NFC100_RESPONSE_CODE?(t="Illegal response code",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1486))):e[1]!=P.SRC_SET_COMMAND_TYPE?(t="Illegal sub-response code",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1490))):e[2]!=P.STATUS_SUCCESS?(t="Invalid Status",E(t),Promise.reject(new h(h.INVALID_STATUS,t,this._fileName,1494))):void 0),E("SetCommandType end")}async InSetRF(e,t,r,i){let n,a,s;if(E("InSetRF begin"),null==e||null==t||null==r||null==i)return n="Invalid parameter",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,1514));a=new Uint8Array(6),a[0]=P.NFC100_COMMAND_CODE,a[1]=P.SCC_IN_SET_RF,a[2]=e,a[3]=t,a[4]=r,a[5]=i,s=await this.tranceive_ext(a).then(e=>3!=e.length?(n="Illegal response length",E(n),Promise.reject(new h(h.INVALID_RESPONSE,n,this._fileName,1532))):e[0]!=P.NFC100_RESPONSE_CODE?(n="Illegal response code",E(n),Promise.reject(new h(h.INVALID_RESPONSE,n,this._fileName,1536))):e[1]!=P.SRC_IN_SET_RF?(n="Illegal sub-response code",E(n),Promise.reject(new h(h.INVALID_RESPONSE,n,this._fileName,1540))):e[2]!=P.STATUS_SUCCESS?(n="Invalid Status",E(n),Promise.reject(new h(h.INVALID_STATUS,n,this._fileName,1544))):void 0),E("InSetRF end")}async InSetProtocol(e){let t,r,i;if(E("InSetProtocol begin"),null==e||0==e.length)return t="Invalid parameter (protocol_array)",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,1564));r=new Uint8Array(2+e.length),r[0]=P.NFC100_COMMAND_CODE,r[1]=P.SCC_IN_SET_PROTOCOL,_(r,2,e,0,e.length),i=await this.tranceive_ext(r).then(e=>3!=e.length?(t="Illegal response length",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1579))):e[0]!=P.NFC100_RESPONSE_CODE?(t="Illegal response code",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1583))):e[1]!=P.SRC_IN_SET_PROTOCOL?(t="Illegal sub-response code",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1587))):e[2]!=P.STATUS_SUCCESS?(t="Invalid Status",E(t),Promise.reject(new h(h.INVALID_STATUS,t,this._fileName,1591))):void 0),E("InSetProtocol end")}async SwitchRF(e){let t,r,i;if(E("SwitchRF begin"),null==e)return t="Invalid parameter (type)",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,1611));r=new Uint8Array(3),r[0]=P.NFC100_COMMAND_CODE,r[1]=P.SCC_SWITCH_RF,r[2]=e,i=await this.tranceive_ext(r).then(e=>3!=e.length?(t="Illegal response length",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1626))):e[0]!=P.NFC100_RESPONSE_CODE?(t="Illegal response code",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1630))):e[1]!=P.SRC_SWITCH_RF?(t="Illegal sub-response code",E(t),Promise.reject(new h(h.INVALID_RESPONSE,t,this._fileName,1634))):e[2]==P.STATUS_TEMPERATURE_ERROR||e[2]==P.STATUS_INTTEMPRFOFF_ERROR?(this.bAbnormalState=!0,t="Temperature error",E(t),Promise.reject(new h(h.DEVICE_FATAL_ERROR,t,this._fileName,1640))):e[2]!=P.STATUS_SUCCESS?(t="Invalid Status",E(t),Promise.reject(new h(h.INVALID_STATUS,t,this._fileName,1644))):void 0),E("SwitchRF end")}async GetPDDataVersion(){let e,t,r;return E("GetPDDataVersion begin"),e=new Uint8Array(2),e[0]=P.NFC100_COMMAND_CODE,e[1]=P.SCC_GET_PDDATA_VERSION,t=await this.tranceive_ext(e).then(e=>4!=e.length?(r="Illegal response length",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1670))):e[0]!=P.NFC100_RESPONSE_CODE?(r="Illegal response code",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1674))):e[1]!=P.SRC_GET_PDDATA_VERSION?(r="Illegal sub-response code",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1678))):[e[3],e[2]]),E("GetPDDataVersion end"),t}async GetProperty(){let e,t,r;return E("GetProperty begin"),e=new Uint8Array(2),e[0]=P.NFC100_COMMAND_CODE,e[1]=P.SCC_GET_PROPERTY,t=await this.tranceive_ext(e).then(e=>34!=e.length?(r="Illegal response length",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1706))):e[0]!=P.NFC100_RESPONSE_CODE?(r="Illegal response code",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1710))):e[1]!=P.SRC_GET_PROPERTY?(r="Illegal sub-response code",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1714))):c(e,2)),E("GetProperty end"),t}async InSetRCT(e,t,r){let i,n;E("InSetRCT begin"),i=new Uint8Array(18+(t.length+1)+(r.length+1)),i[0]=P.NFC100_COMMAND_CODE,i[1]=P.SCC_IN_SET_RCT,_(i,2,e),i[18]=t.length/3,_(i,19,t),i[19+t.length]=r.length/3,_(i,19+t.length+1,r),await this.tranceive_ext(i).then(e=>3!=e.length?(n="Illegal response length",E(n),Promise.reject(new h(h.INVALID_RESPONSE,n,this._fileName,1746))):e[0]!=P.NFC100_RESPONSE_CODE?(n="Illegal response code",E(n),Promise.reject(new h(h.INVALID_RESPONSE,n,this._fileName,1750))):e[1]!=P.SRC_IN_SET_RCT?(n="Illegal sub-response code",E(n),Promise.reject(new h(h.INVALID_RESPONSE,n,this._fileName,1754))):e[2]==P.STATUS_PARAMETER_ERROR?(n="PARAMETER_ERROR",E(n),Promise.reject(new h(h.UNKNOWN_ERROR,n,this._fileName,1758))):e[2]==P.STATUS_PWD_ERROR?(n="PWD_ERROR",E(n),Promise.reject(new h(h.UNKNOWN_ERROR,n,this._fileName,1762))):e[2]!=P.STATUS_SUCCESS?(n="Invalid status",E(n),Promise.reject(new h(h.INVALID_STATUS,n,this._fileName,1766))):void 0),E("InSetRCT end")}async InGetRCT(e){let t,r,i,n,a,s,o,l;return E("InGetRCT begin"),t=new Uint8Array(18),t[0]=P.NFC100_COMMAND_CODE,t[1]=P.SCC_IN_GET_RCT,_(t,2,e),r=await this.tranceive_ext(t).then(e=>e.length<11?(i="Illegal response length",E(i),Promise.reject(new h(h.INVALID_RESPONSE,i,this._fileName,1800))):e[0]!=P.NFC100_RESPONSE_CODE?(i="Illegal response code",E(i),Promise.reject(new h(h.INVALID_RESPONSE,i,this._fileName,1804))):e[1]!=P.SRC_IN_GET_RCT?(i="Illegal sub-response code",E(i),Promise.reject(new h(h.INVALID_RESPONSE,i,this._fileName,1808))):e[2]==P.STATUS_PWD_ERROR?(i="PWD_ERROR",E(i),Promise.reject(new h(h.UNKNOWN_ERROR,i,this._fileName,1812))):e[2]!=P.STATUS_SUCCESS?(i="Invalid status",E(i),Promise.reject(new h(h.INVALID_STATUS,i,this._fileName,1816))):c(e,3)),a=3*r[0],s=c(r,1,a),o=3*r[1+a],l=c(r,1+a+1,o),n={},n.in_send_setting=s,n.in_receive_setting=l,E("InGetRCT end"),n}async ReadRegister(e,t){let r,i,n;return E("ReadRegister begin"),null==e||null==t?(r="Invalid parameter",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,1847))):(i=new Uint8Array(19),i[0]=P.NFC100_COMMAND_CODE,i[1]=P.SCC_READ_REGISTER,_(i,2,e,0,e.length),i[18]=t,n=await this.tranceive_ext(i).then(e=>5!=e.length?(r="Illegal response length",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1863))):e[0]!=P.NFC100_RESPONSE_CODE?(r="Illegal response code",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1867))):e[1]!=P.SRC_READ_REGISTER?(r="Illegal sub-response code",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1871))):e[2]!=P.STATUS_SUCCESS?(r="Invalid Status",E(r),Promise.reject(new h(h.INVALID_STATUS,r,this._fileName,1875))):e[3]!=t?(r="Invalid read address",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1879))):e[4]),E("ReadRegister end"),n)}async InCommRF(e,t){let r,i,n,a,c,o,l;return E("InCommRF begin"),null==e||null==t?(r="Invalid parameter",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,1905))):(E("SendData : "+s(e)),i=new Uint8Array(4+e.length),i[0]=P.NFC100_COMMAND_CODE,i[1]=P.SCC_IN_COMM_RF,u(i,2,10*t),_(i,4,e,0,e.length),n=await this.tranceive_ext(i).then(e=>e.length<6?(r="Illegal response length",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1922))):e[0]!=P.NFC100_RESPONSE_CODE?(r="Illegal response code",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1926))):e[1]!=P.SRC_IN_COMM_RF?(r="Illegal sub-response code",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1930))):0!=I(e,2)?(a=I(e,2),a==P.COM_STATUS_TEMPERATURE_ERROR||a==P.COM_STATUS_INTTEMPRFOFF_ERROR?(c=h.DEVICE_FATAL_ERROR,r="Invalid Status(Temperature error)",this.bAbnormalState=!0):a==P.COM_STATUS_REC_TIMEOUT_ERROR?(c=h.THRU_RESPONSE_PACKET_NOT_RECEIVED,r="Invalid Status(Card response timeout)"):(c=h.INVALID_STATUS,r="Invalid Status"),E(r),o=new h(c,r,this._fileName,1946),o.communicationStatus=a,Promise.reject(o)):6==e.length?(r="Illegal response length",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1952))):8!=e[6]?(r="Illegal RxLastBit",E(r),Promise.reject(new h(h.INVALID_RESPONSE,r,this._fileName,1956))):(l=new Array(e.length-7),e.length-7>0&&_(l,0,e,7,e.length-7),E("Response :"+s(l)),l)),E("InCommRF end"),n)}async typea_reqa_wupa(){E("typea_reqa_wupa begin");const e=[P.NFC100_TYPEA_CMD_REQA];let t,r,i;await this.InSetProtocol([1,0,2,0,4,0,5,1,6,0,7,7,8,0]),t=g;try{r=await this.InCommRF(e,t)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}return 2!=r.length?(i="Invalid ATQA length",E("Invalid ATQA length"),Promise.reject(new h(h.CARD_NOT_DETECTED,"Invalid ATQA length",this._fileName,2010))):(E("typea_reqa_wupa ATQA="+s(r)),E("typea_reqa_wupa end"),r)}async typea_anticollision(){E("typea_anticollision begin");const e=[1,1,2,1,6,0],t=[1,0,2,0,6,1];let r,i,n,a,c,o,u,T,I;for(await this.InSetProtocol([4,1,6,1,7,8]),r=g,i=[],n=1;n<=3;n++){a=P.NFC100_TYPEA_CMD_SEL_CL_1,2==n?a=P.NFC100_TYPEA_CMD_SEL_CL_2:3==n&&(a=P.NFC100_TYPEA_CMD_SEL_CL_3),c=[a,32];try{o=await this.InCommRF(c,r)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}if(5!=o.length)return u="Invalid uid-cln length",E(u),Promise.reject(new h(h.CARD_NOT_DETECTED,u,this._fileName,2080));await this.InSetProtocol(e),T=[a,112,0,0,0,0,0],_(T,2,o,0,o.length);try{I=await this.InCommRF(T,r)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}if(1!=I.length)return u="Invalid SAK length",E(u),Promise.reject(new h(h.CARD_NOT_DETECTED,u,this._fileName,2103));if(0==(4&I[0])){l(i,o,0,4);break}l(i,o,1,3),await this.InSetProtocol(t)}return E("typea_anticollision SAK="+s(I)),E("typea_anticollision UID="+s(i)),E("typea_anticollision end"),new Uint8Array(i)}async typea_iso14443_4_activate(e,t,r){let i,n,a,_,c,o,l,u,T,I,N,A,m,d,C,g,y;E("typea_iso14443_4_activate begin"),i=[224,0],i[1]=e<<4&240|15&t,n=S(71680),n+=20;try{a=await this.InCommRF(i,n)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}if(E("typea_iso14443_4_activate ATS="+s(a)),a.length<0)return _="Invalid ATS length",E(_),Promise.reject(new h(h.CARD_NOT_DETECTED,_,this._fileName,2165));if(a.length<5||a[0]<5)return _="Invalid ATS length",E(_),Promise.reject(new h(h.CARD_NOT_DETECTED,_,this._fileName,2172));if(c=15&a[1],o=a[2]>>4&3,l=3&a[2],await R(P.ISO14443_4_CC_DEFAULT_SFGI),m=P.BAUDRATE_106K,r&&(0!=o||0!=l)&&(0!=(2&o)&&0!=(2&l)?(u=2,T=2):0!=(1&o)&&0!=(1&l)?(u=1,T=1):(u=0,T=0),0!=u||0!=T)){I=[208,17,0],I[0]=208+(15&t),I[2]=u<<2&12|3&T,N=4,n=O(4),n+=f,n+=20;try{A=await this.InCommRF(I,n)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}if(E("typea_iso14443_4_activate PPSRES="+s(A)),1!=A.length)return _="Invalid PPS-Response length",E(_),Promise.reject(new h(h.CARD_NOT_DETECTED,_,this._fileName,2216));if(208!=(240&A[0]))return _="PPS-Response status error",E(_),Promise.reject(new h(h.CARD_NOT_DETECTED,_,this._fileName,2220));2==u?(d=P.NFC100_RBT_INITIATOR_ISO14443A_424K,C=P.NFC100_RF_INITIATOR_ISO14443A_424K,m=P.BAUDRATE_424K):1==u?(d=P.NFC100_RBT_INITIATOR_ISO14443A_212K,C=P.NFC100_RF_INITIATOR_ISO14443A_212K,m=P.BAUDRATE_212K):(d=P.NFC100_RBT_INITIATOR_ISO14443A_106K,C=P.NFC100_RF_INITIATOR_ISO14443A_106K),2==T?(g=P.NFC100_RBT_INITIATOR_ISO14443A_424K,y=P.NFC100_RF_INITIATOR_ISO14443A_424K):1==T?(g=P.NFC100_RBT_INITIATOR_ISO14443A_212K,y=P.NFC100_RF_INITIATOR_ISO14443A_212K):(g=P.NFC100_RBT_INITIATOR_ISO14443A_106K,y=P.NFC100_RF_INITIATOR_ISO14443A_106K),await this.InSetRF(d,C,g,y)}super._targetCardBaudRate=m,E("typea_iso14443_4_activate end")}async typea_mifareAuth(e){let t,r,i,n;if(E("typea_mifareAuth begin"),null==e)return t="Invalid parameter",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,2275));if(null==e.key||6!=e.key.length)return t="Invalid key length",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,2279));if("KeyA"!=e.keyType&&"KeyB"!=e.keyType)return t="Invalid keyType",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,2283));if(e.blockNumber<0||e.blockNumber>255)return t="Invalid blockNumber",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,2287));if(null==e.uid||0==e.uid.length)return t="Invalid uid",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,2291));await this.InSetProtocol([8,1]),r=[96,e.blockNumber,0,0,0,0,0,0],"KeyA"==e.keyType?r[0]=96:r[0]=97,_(r,2,e.key,0,6),l(r,e.uid),i=P.COMMUNICATE_THRU_DEFAULT_TIMEOUT;try{if(n=await this.InCommRF(r,i),0!=n.length)return t="Invalid Mifare authentication response length",E(t),Promise.reject(new h(h.AUTHENTICATION_ERROR,t,this._fileName,2312))}catch(e){return t="mifare authentication error",E(t),Promise.reject(new h(h.AUTHENTICATION_ERROR,t,this._fileName,2319))}E("typea_mifareAuth end")}async typeb_reqb_wupb(e,t,r,i){let n,a,_,o,l,u,T,I;E("typeb_reqb_wupb begin"),n=[P.NFC100_TYPEB_CMD_REQB,e,0],t||(n[2]|=8),r&&(n[2]|=16),i&&(n[2]|=32),a=S(7680),a+=20;try{_=await this.InCommRF(n,a)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}return E("typeb_reqb_wupb ATQB="+s(_)),r&&12!=_.length&&13!=_.length||!r&&12!=_.length?(o="Invalid ATQB length",E("Invalid ATQB length"),Promise.reject(new h(h.CARD_NOT_DETECTED,"Invalid ATQB length",this._fileName,2373))):(l=c(_,1,4),u=c(_,5,4),T=c(_,9,_.length-9),I=new C(l,u,T),E("pupi : "+s(l)),E("application_data : "+s(u)),E("protocol_info : "+s(T)),E("typeb_reqb_wupb end"),I)}async typeb_iso14443_4_activate(e,t,r,i,n,a){let c,o,l,u,T,I,N,A,m,d,C,S,g,y,p;E("typeb_iso14443_4_activate begin"),E("  param pupi : "+s(e)),E("  param fsdi : "+t),E("  param protocol_info : "+s(r)),E("  param cid="+i),E("  param autoBaudRate="+a),c=r[0]>>4&3,o=3&r[0],l=0,u=0,!a||0==c&&0==o||(0!=(2&c)&&0!=(2&o)?(l=2,u=2):0!=(1&c)&&0!=(1&o)&&(l=1,u=1)),T=9,null!=n&&0!=n.length?(E("  param higher_layer_inf="+s(n)),T+=n.length):E("  param higher_layer_inf=(null)"),I=new Uint8Array(T),I[0]=P.NFC100_TYPEB_CMD_ATTRIB,_(I,1,e,0,4),I[5]=0,I[6]=l<<6&192|u<<4&48|t,I[7]=15&r[1],I[8]=i,null!=n&&0!=n.length&&_(I,9,n,0,n.length),N=4,A=O(4),A+=f,A+=20;try{m=await this.InCommRF(I,A)}catch(e){return e.errorType==h.THRU_RESPONSE_PACKET_NOT_RECEIVED&&(e.errorType=h.CARD_NOT_DETECTED,e.message="Card not detected"),Promise.reject(e)}if(E("typeb attrib_data="+s(m)),m.length>P.TYPEB_CARD_MAX_ATTRIB_LEN)return d="Invalid attrib_data length",E(d),Promise.reject(new h(h.CARD_NOT_DETECTED,d,this._fileName,2470));C=P.BAUDRATE_106K,0==l&&0==u||(2==l?(S=P.NFC100_RBT_INITIATOR_ISO14443B_424K,g=P.NFC100_RF_INITIATOR_ISO14443B_424K,C=P.BAUDRATE_424K):1==l?(S=P.NFC100_RBT_INITIATOR_ISO14443B_212K,g=P.NFC100_RF_INITIATOR_ISO14443B_212K,C=P.BAUDRATE_212K):(S=P.NFC100_RBT_INITIATOR_ISO14443B_106K,g=P.NFC100_RF_INITIATOR_ISO14443B_106K),2==u?(y=P.NFC100_RBT_INITIATOR_ISO14443B_424K,p=P.NFC100_RF_INITIATOR_ISO14443B_424K):1==u?(y=P.NFC100_RBT_INITIATOR_ISO14443B_212K,p=P.NFC100_RF_INITIATOR_ISO14443B_212K):(y=P.NFC100_RBT_INITIATOR_ISO14443B_106K,p=P.NFC100_RF_INITIATOR_ISO14443B_106K),await this.InSetRF(S,g,y,p)),super._targetCardBaudRate=C,await R(P.ISO14443_4_CC_DEFAULT_SFGI),E("typeb_iso14443_4_activate end")}}const y=new Uint8Array([255,255]);var p=!1;class D{constructor(){this._fileName="NFCPortLib.js",this.deviceName=null,this.targetCardBaudRate=null,this._rw=null,this._config=null,this._status="S0","undefined"!=typeof NFCPortLibDebugMode&&(E=console.log)}async init(e){let t;if(E("init begin"),p)return t="A call occurred during a library call.",E(t),Promise.reject(new h(h.API_CALL_IN_PROGRESS,t,this._fileName,98));p=!0;try{await this.init_internal(e)}catch(e){return p=!1,Promise.reject(e)}p=!1,E("init end")}async open(){let e;if(E("open begin"),p)return e="A call occurred during a library call.",E(e),Promise.reject(new h(h.API_CALL_IN_PROGRESS,e,this._fileName,140));p=!0;try{await this.open_internal()}catch(e){return p=!1,Promise.reject(e)}p=!1,E("open end")}async detectCard(e,t){let r,i;if(E("detectCard begin"),p)return r="A call occurred during a library call.",E(r),Promise.reject(new h(h.API_CALL_IN_PROGRESS,r,this._fileName,194));p=!0;try{i=await this.detectCard_internal(e,t)}catch(e){return p=!1,Promise.reject(e)}return p=!1,E("detectCard end"),i}async communicateThru(e,t,r){let i,n;if(E("communicateThru begin"),p)return n="A call occurred during a library call.",E(n),Promise.reject(new h(h.API_CALL_IN_PROGRESS,n,this._fileName,247));p=!0;try{i=await this.communicateThru_internal(e,t,r)}catch(e){return p=!1,Promise.reject(e)}return p=!1,E("communicateThru end"),i}async switchRF(e){let t;if(E("switchRF begin"),p)return t="A call occurred during a library call.",E(t),Promise.reject(new h(h.API_CALL_IN_PROGRESS,t,this._fileName,294));p=!0;try{await this.switchRF_internal(e)}catch(e){return p=!1,Promise.reject(e)}p=!1,E("switchRF end")}async close(){let e;if(E("close begin"),p)return e="A call occurred during a library call.",E(e),Promise.reject(new h(h.API_CALL_IN_PROGRESS,e,this._fileName,335));p=!0;try{await this.close_internal()}catch(e){return p=!1,Promise.reject(e)}p=!1,E("close end")}async init_internal(e){let t;if(E("init_internal begin"),null!=e){if("object"!=typeof e)return t="The config is incorrect type.",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,369));if(null!=e.ackTimeout&&"number"!=typeof e.ackTimeout)return t="config.ackTimeout is incorrect type",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,373));if(null!=e.ackTimeout&&(e.ackTimeout<0||e.ackTimeout>6553))return t="config.ackTimeout is out of range",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,378));if(null!=e.receiveTimeout&&"number"!=typeof e.receiveTimeout)return t="config.receiveTimeout is incorrect type",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,382));if(null!=e.receiveTimeout&&(e.receiveTimeout<0||e.receiveTimeout>6553))return t="config.receiveTimeout is out of range",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,387));if(null!=e.autoBaudRate&&"boolean"!=typeof e.autoBaudRate)return t="config.autoBaudRate is incorrect type",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,391));if(null!=e.autoDeviceSelect&&"boolean"!=typeof e.autoDeviceSelect)return t="config.autoDeviceSelect is incorrect type",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,395))}if(null==e?e=new m(1e3,1e3,!1,!0):(null!=e.ackTimeout?e.ackTimeout<400&&(e.ackTimeout=400):e.ackTimeout=1e3,null!=e.receiveTimeout?e.receiveTimeout<400&&(e.receiveTimeout=400):e.receiveTimeout=1e3,null==e.autoBaudRate&&(e.autoBaudRate=!1),null==e.autoDeviceSelect&&(e.autoDeviceSelect=!0)),null!=this._rw)try{await this._rw.close()}catch(e){}this._rw=null,this.deviceName=null,this.targetCardBaudRate=null,this._config=e,this._status="S1",E("init_internal end")}async open_internal(){let e,t;if(E("open_internal begin"),"S1"!=this._status&&"S3"!=this._status)return t="Can not callout Library Status (Status="+this._status+")",E(t),Promise.reject(new h(h.CANTCALLOUT_LIBRARY_STATUS,t,this._fileName,485));e=new P;try{await e.init(this._config),await e.open()}catch(e){return Promise.reject(e)}this.deviceName=e.deviceName,this._rw=e,this._status="S2",E("open_internal end")}async detectCard_internal(e,t){let r,i;if(E("detectCard_internal begin"),null==e)return r="The protocol is not specified.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,502));if("string"!=typeof e)return r="The protocol is incorrect type.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,506));if(null!=t){if("object"!=typeof t)return r="The option is incorrect type.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,511));if(null!=t.systemCode&&("object"!=typeof t.systemCode||"Uint8Array"!=t.systemCode.constructor.name||0!=t.systemCode.length&&2!=t.systemCode.length))return r="The option.systemCode is incorrect type.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,518));if(null!=t.timeSlot&&"number"!=typeof t.timeSlot)return r="The option.timeSlot is incorrect type.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,522));if(null!=t.requestSystemCode&&"boolean"!=typeof t.requestSystemCode)return r="The option.requestSystemCode is incorrect type.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,526));if(null!=t.requestBaudRate&&"boolean"!=typeof t.requestBaudRate)return r="The option.requestBaudRate is incorrect type.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,530));if(null!=t.fsdi&&"number"!=typeof t.fsdi)return r="The option.fsdi is incorrect type.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,534));if(null!=t.cid&&"number"!=typeof t.cid)return r="The option.cid is incorrect type.",E(r),Promise.reject(new h(h.INVALID_PARAMETER,r,this._fileName,538))}if(null==t?t=new d(y,0,!0,!1):(null==t.systemCode&&(t.systemCode=y),null==t.timeSlot&&(t.timeSlot=0),null==t.requestSystemCode&&(t.requestSystemCode=!0),null==t.requestBaudRate&&(t.requestBaudRate=!1)),"S2"!=this._status)return r="Can not callout Library Status (Status="+this._status+")",E(r),Promise.reject(new h(h.CANTCALLOUT_LIBRARY_STATUS,r,this._fileName,589));try{i=await this._rw.detectCard(e,t)}catch(e){return this._rw.bAbnormalState&&(this._status="S4"),Promise.reject(e)}return this.targetCardBaudRate=this._rw.targetCardBaudRate,E("detectCard_internal end"),i}async communicateThru_internal(e,t,r){let i,n;if(E("communicateThru_internal begin"),null!=e){if("object"!=typeof e||"Uint8Array"!=e.constructor.name)return n="The command is incorrect type.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,607));if(e.length>290)return n="The command is incorrect size.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,611));if(null==t)return n="The timeout is not specified.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,615));if("number"!=typeof t)return n="The timeout is incorrect type.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,619));if(t<0||t>6553)return n="The timeout is out of range",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,623));t<400&&(t=400)}else if(null==r)return n="The command is not specified",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,635));if(null!=r){if("object"!=typeof r)return n="The option is incorrect type.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,644));if(null!=r.mifareAuthentication&&"boolean"!=typeof r.mifareAuthentication)return n="The option.mifareAuthentication is incorrect type.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,648));if(null!=r.key&&("object"!=typeof r.key||"Uint8Array"!=r.key.constructor.name))return n="The option.key is incorrect type.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,652));if(null!=r.keyType&&"string"!=typeof r.keyType)return n="The option.keyType is incorrect type.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,656));if(null!=r.blockNumber&&"number"!=typeof r.blockNumber)return n="The option.blockNumber is incorrect type.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,660));if(null!=r.uid&&("object"!=typeof r.uid||"Uint8Array"!=r.uid.constructor.name))return n="The option.uid is incorrect type.",E(n),Promise.reject(new h(h.INVALID_PARAMETER,n,this._fileName,664))}if("S2"!=this._status)return n="Can not callout Library Status (Status="+this._status+")",E(n),Promise.reject(new h(h.CANTCALLOUT_LIBRARY_STATUS,n,this._fileName,684));try{i=await this._rw.communicateThru(e,t,r)}catch(e){return this._rw.bAbnormalState&&(this._status="S4"),Promise.reject(e)}return E("communicateThru_internal end"),i}async switchRF_internal(e){let t;if(E("switchRF_internal begin"),null==e)return t="Parameter is not specified.",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,700));if("boolean"!=typeof e)return t="Parameter is incorrect type.",E(t),Promise.reject(new h(h.INVALID_PARAMETER,t,this._fileName,704));if("S2"!=this._status)return t="Can not callout Library Status (Status="+this._status+")",E(t),Promise.reject(new h(h.CANTCALLOUT_LIBRARY_STATUS,t,this._fileName,724));try{await this._rw.switchRF(e)}catch(e){return this._rw.bAbnormalState&&(this._status="S4"),Promise.reject(e)}E("switchRF_internal end")}async close_internal(){let e;if(E("close_internal begin"),"S2"==this._status||"S4"==this._status){if(null!=this._rw){try{await this._rw.close()}catch(e){E(e.message)}this._rw=null}this._status="S3"}else e="Do nothing Library Status (Status="+this._status+")",E(e);E("close_internal end")}}class w{constructor(){this.systemCode=3,this.card_type="iso18092",this.lib=new D,this.idm=0,this.pmm=0,this.pupi=0,this.ackTimeout=500,this.receiveTimeout=500,this.autoBaudRate=!1,this.autoDeviceSelect=!1,this.stationData={},this.stationDataUrl=location.origin+location.pathname+"resources/StationCode.csv"}async _fetchStationData(){try{let e=await fetch(this.stationDataUrl);(await e.text()).split("\n").forEach((e,t)=>{if(0!=t){let t=e.split(",");t.forEach((e,r)=>{r<=3&&(t[r]=t[r].toLocaleLowerCase())}),void 0===this.stationData[t[0]]&&(this.stationData[t[0]]={}),void 0===this.stationData[t[0]][t[1]]&&(this.stationData[t[0]][t[1]]={}),this.stationData[t[0]][t[1]][t[2]]={company:t[3],line:t[4],station:t[5]}}})}catch(e){console.error(e)}}async convertHexStationInfoToText(e=null,t=null,r=null){if(null==e||null==t||null==r)return null;let i=parseInt("0x"+e).toString(16),n=parseInt("0x"+t).toString(16),a=parseInt("0x"+r).toString(16),s=null;try{s=this.stationData[i][n][a],void 0===s&&(s={company:"undefined",line:"undefined",station:"undefined"})}catch(e){s=null}return s}convertHextToDate(e=[]){let t=parseInt("0x"+e.join("")),r=31&t;return`${2e3+(t>>9)}-${("00"+(t>>5&15)).substr(-2)}-${("00"+r).substr(-2)}`}convertHexToString(e=null,t=null){if(null==e||null==t)return"--";return{machine:{"0x03":"精算機","0x04":"携帯型端末","0x05":"車載端末","0x07":"券売機","0x08":"券売機","0x09":"入金機","0x12":"券売機","0x14":"券売機等","0x15":"券売機等","0x16":"改札機","0x17":"簡易改札機","0x18":"窓口端末","0x19":"窓口端末","0x1a":"改札端末","0x1b":"携帯電話","0x1c":"乗継精算機","0x1d":"連絡改札機","0x1f":"簡易入金機","0x46":"VIEW ALTTE","0x48":"VIEW ALTTE","0xc7":"物販端末","0xc8":"自販機"},trans:{"0x01":"運賃支払(改札出場)","0x02":"チャージ","0x03":"券購(磁気券購入)","0x04":"精算","0x05":"精算 (入場精算)","0x06":"窓出 (改札窓口処理)","0x07":"新規 (新規発行)","0x08":"控除 (窓口控除)","0x0d":"バス (PiTaPa系)","0x0e":"バス (IruCa系)","0x11":"再発 (再発行処理)","0x13":"支払 (新幹線利用)","0x14":"入A (入場時オートチャージ)","0x15":"出A (出場時オートチャージ)","0x1f":"入金 (バスチャージ)","0x23":"券購 (バス路面電車企画券購入)","0x46":"物販","0x48":"特典 (特典チャージ)","0x49":"入金 (レジ入金)","0x4a":"物販取消","0x4b":"入物 (入場物販)","0xc6":"物現 (現金併用物販)","0xcb":"入物 (入場現金併用物販)","0x84":"精算 (他社精算)","0x85":"精算 (他社入場精算)"}}[e][t.toLocaleLowerCase()]}splitStringToByteArray(e=null){return e.match(/.{2}/g)}convToHexString(e="0"){let t=[];return e.forEach(e=>{t.push(("00"+e.toString(16)).substr(-2))}),t}async init(e=500,t=500,r=!0,i=!0){this.ackTimeout=e,this.receiveTimeout=t,this.autoBaudRate=r,this.autoDeviceSelect=i;let n=new m(this.ackTimeout,this.receiveTimeout,this.autoBaudRate,this.autoDeviceSelect);0==Object.keys(this.stationData).length&&await this._fetchStationData(),await this.lib.init(n)}async open(){let e={success:!1};try{await this.lib.open()}catch(t){return e}return e.success=!0,e}async close(){await this.lib.close()}async detectCard(){let e=new d(new Uint8Array([255,255]),0,!0,!1,null),t={success:!1,data:{}};try{let r=await this.lib.detectCard(this.card_type,e);this.idm=r.idm,this.pmm=r.pmm,this.systemcode=r.systemCode,0==r.systemCode[0]&&3==r.systemCode[1]?(this.pupi=r.pupi,this.baudrate=r.baudRate?r.baudRate:this.lib.targetCardBaudRate,t={success:!0,data:{idm:n.array_tohexs(this.idm),pmm:n.array_tohexs(this.pmm),systemcode:null!=this.systemcode?n.array_tohexs(this.systemcode):null,baudrate:this.targetCardBaudRate}}):t={success:!1,data:{error_code:"NOT_CJRC",msg:"SystemCode is not CJRC standard",raw:r}}}catch(e){t.data={success:!1,data:{msg:"Card was not detected.",raw:e}}}return t}async getAllCardHistory(e=20){const t=(e,t=0)=>{let r=[];for(var i=0;i<e;i++)r=r.concat([128,i+t]);return r},r=async(e,t)=>{let r={success:!1,data:{}},i={};try{let a=await this.lib.communicateThru(e,100,t);i={request:n.array_tohexs(e),response:n.array_tohexs(a)},r.success=!0,r.data=i}catch(e){r.success=!1,r.data={msg:"Read error",raw:e}}return r};let i={success:!1,data:{}},a=[];for(let e=1;e<=2;e++){let n=new d(new Uint8Array([255,255]),0,!0,!1,null),s=[6],_=[];this.idm.forEach(e=>{_.push(e.toString())}),s=s.concat(_),s=s.concat([1,15,9]),s=s.concat([10]),s=s.concat(t(10,10*(e-1))),s=[s.length+1].concat(s),s=new Uint8Array(s);try{let e=await r(s,n);if(!1===e.success)return e;let t=await this.decodeResponse("history",e.data);if(0==t.succcess)return e;a=a.concat(t.data.decoded)}catch(e){i.success=!1,i.data={msg:"Read error",raw:e}}}return i.success=!0,a.sort((e,t)=>t.seq_no-e.seq_no),i.data.decoded=a,i}async decodeResponse(e=null,t=null){let r={succcess:!1,data:{raw:t,decoded:{}},error:{msg:"DEFAULT ERROR Message"}};if(null==e||null==t)return r.error.msg=`[PARAM NOT SET] type=[${e}] res_to_decode=[${res_to_decode}]`,r;let i=0,n=[];switch(e){case"balance":i=13,i+=11;let e=0;n=this.splitStringToByteArray(t.response).splice(i-1,2),e=parseInt("0x"+n[0]<<0)+parseInt("0x"+n[1]<<8),r.succcess=!0,r.data.decoded={balance:e},r.error.msg=null;break;case"history":i=13,n=this.splitStringToByteArray(t.response);let a={raw:[],decoded:[]};for(let e=0;e<20&&!(n.length<16*(e+1));e++)a.raw.push(n.slice().splice(i+16*e,16));await a.raw.forEach(async(e,t)=>{let r=null,i=!1,n=!1,s=!1,_=!1,c=null,o=null,l=e[0].toLocaleLowerCase();if("05"==l)i=!0;else if("c7"==l||"c8"==l){n=!0;let t=parseInt("0x"+e[6]+e[7]);r=("00"+(t>>11).toString()).substr(-2)+":"+("00"+(t>>5&63).toString()).substr(-2)}else if("02"==e[1].toLocaleLowerCase())s=!0,c=await this.convertHexStationInfoToText(e[15],e[6],e[7]);else{_=!0;try{c=await this.convertHexStationInfoToText(e[15],e[6],e[7]),o=await this.convertHexStationInfoToText(e[15],e[8],e[9])}catch(e){console.error(e)}}a.decoded.push({raw_hex_string:e.join(""),console_type:this.convertHexToString("machine","0x"+e[0]),console_is:{bus:i,product_sale:n,charge:s,train:_},transaction:this.convertHexToString("trans","0x"+e[1]),q00:[parseInt("0x"+e[2]),parseInt("0x"+e[3])],date:this.convertHextToDate([e[4],e[5]]),time:r,in_line:null,in_station_order:null,in_station:c,out_line:parseInt("0x"+e[8]),out_station_order:parseInt("0x"+e[9]),out_station:o,balance:(parseInt("0x"+e[10])<<0)+(parseInt("0x"+e[11])<<8),seq_no:parseInt("0x"+e[12]+e[13]+e[14]),region:parseInt("0x"+e[15])})}),r.succcess=!0,r.data.decoded=a.decoded,r.error.msg=null}return r}}(async()=>{let e=new w,t=document.querySelector("#title-header"),r=t.offsetTop,a={error:[]},s=document.querySelector("div#pbar"),_=document.querySelector("#history_area"),c=document.querySelector("#show-idm");window.onscroll=()=>{window.pageYOffset>r?t.classList.add("header-sticky"):t.classList.remove("header-sticky")};const o=(e=!0)=>{let t=document.querySelector("#read_felica"),r=document.querySelector("#clear_history");!0===e?(t.removeAttribute("disabled"),r.removeAttribute("disabled")):(t.setAttribute("disabled","disabled"),r.setAttribute("disabled","disabled"))},l=(e="0",t="yen")=>{let r="",i=!1;switch(e<0&&(i=!0),e=Math.abs(e),t){case"yen":r="&yen;"}return i&&(r="&#9650;"+r),r+""+Number(parseFloat(parseInt(e,10)).toFixed(2)).toLocaleString("en",{minimumFractionDigits:0})};n.enableDebugLog(i);document.querySelector("#read_felica").addEventListener("click",()=>{!async function(){s.classList.remove("none_hidden"),o(!1);if(c.innerHTML="",_.innerHTML="",message_area.innerHTML="",await e.init(),!1===(await e.open()).success)return console.error("[ERROR] Card Reader could not properly be selected."),void await T("カードリーダを正常に選択できませんでした。",null);try{let t=await e.detectCard();if(!1===t.success){let e="カードを検出できませんでした。<br>カードリーダにカードを載せてください。";return"NOT_CJRC"==t.data.error_code&&(e="交通系カードではないようです。<br>交通系カードを載せて再度お試しください。"),void await T(e,t)}c.innerHTML=`[Card ID: ${((e=null)=>e.match(/.{2}/g).join(" "))(t.data.idm)}]`}catch(t){return console.error("[ERROR] during detecting card.",t),await T("カードを検出中にエラーが発生しました。",ret_basic),void await e.close()}try{let t=await e.getAllCardHistory();if(!1===t.success)return void await T("カードのデータ取得中にエラーが発生しました。<br>再度お試しください。",err);let r=document.querySelector("#template-history-design-item-01");t.data.decoded.forEach((e,i)=>{let n=r.cloneNode(!0);n.querySelector("#history-date").innerHTML=""+e.date,null!=e.time&&(n.querySelector("#history-date").innerHTML+=" "+e.time),n.querySelector("#history-type").innerHTML=`${e.transaction} @${e.console_type}`;let a=document.createElement("i");a.classList.add("material-icons"),a.innerHTML="device_unknown";let s="--";i<t.data.decoded.length-1&&(s=t.data.decoded[i].balance-t.data.decoded[i+1].balance,s=l(s,"yen")),n.querySelector("#history-inc_dec").innerHTML=""+s,e.console_is.train&&(a.innerHTML="directions_transit",n.querySelector("#history-in_station").innerHTML=`${e.in_station.station} (${e.in_station.company})`,n.querySelector("#history-out_station").innerHTML=`${e.out_station.station} (${e.out_station.company})`),e.console_is.bus&&(a.innerHTML="directions_bus",n.querySelector("#history-in_station_all").innerHTML="",n.querySelector("#history-out_station_all").innerHTML=""),e.console_is.product_sale&&(a.innerHTML="local_mall",n.querySelector("#history-in_station_all").innerHTML="",n.querySelector("#history-out_station_all").innerHTML=""),e.console_is.charge&&(a.innerHTML="local_atm",n.querySelector("#history-in_station_all").innerHTML=`<i class="material-icons">check</i> ${e.in_station.station} (${e.in_station.company})`,n.querySelector("#history-out_station_all").innerHTML=""),n.querySelector("#history-type-icon").innerHTML="",n.querySelector("#history-type-icon").appendChild(a),n.querySelector("#history-balance").innerHTML=""+l(e.balance,"yen"),n.querySelector("#history-seq").innerHTML=`(seq:${e.seq_no})`,_.appendChild(n)})}catch(e){return void await T("カードと通信中にエラーが発生しました。<br>再度お試しください。",e)}await e.close(),o(!0),s.classList.add("none_hidden")}()},!1),document.querySelector("#clear_history").addEventListener("click",()=>{_.innerHTML="",c.innerHTML="",u()},!1);const u=()=>{if(0==document.querySelector("#history_area").childNodes.length){document.querySelector("#show-idm").innerHTML="",document.querySelector("#message_area").innerHTML="",document.querySelector("#message_area").appendChild(document.querySelector("#message_area").appendChild(document.querySelector("#instrunction-00").cloneNode(!0)))}},T=async(t="Something went wrong.",r={})=>{((e="Something went wrong.")=>{let t=document.querySelector("#template-error-design-00").cloneNode(!0);for(;a.error.length>0;)clearTimeout(a.error.pop());u();let r=document.querySelector("#message_area");t.querySelector("#message").innerHTML=e,r.innerHTML="",r.appendChild(t),a.error.push(setTimeout(()=>{t.style.setProperty("opacity","0")},5e3)),a.error.push(setTimeout(()=>{r.innerHTML="",u()},5800))})(t),await e.close(),o(!0),s.classList.add("none_hidden")};u(),(()=>{if(void 0===navigator.usb){document.querySelector("#message_area").innerHTML="";let e=document.querySelector("#instrunction-01"),t=document.querySelector("#browse_warning_area");t.innerHTML="",t.appendChild(e),o(!1)}})()})()}]);
//# sourceMappingURL=bundle.js.map